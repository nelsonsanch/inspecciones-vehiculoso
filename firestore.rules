rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // NOTA: La verificación de roles se hace en la aplicación, no en Firestore
    // Esto evita problemas de performance y timing con get()
    
    // Reglas para colección de usuarios
    match /users/{userId} {
      // Leer: Usuario puede leer su propio documento o cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escribir: Solo el mismo usuario o durante creación
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated();
    }
    
    // Reglas para colección de vehículos
    match /vehiculos/{vehiculoId} {
      // Cualquier usuario autenticado puede leer vehículos
      allow read: if isAuthenticated();
      
      // Cualquier usuario autenticado puede escribir
      // (la verificación de admin se hace en la app)
      allow write: if isAuthenticated();
    }
    
    // Reglas para eventos de vehículos (subcolección)
    match /vehiculos/{vehiculoId}/eventos/{eventoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Reglas para colección de inspecciones
    match /inspecciones/{inspeccionId} {
      // Cualquier usuario autenticado puede leer inspecciones
      allow read: if isAuthenticated();
      
      // Cualquier usuario autenticado puede crear inspecciones
      allow create: if isAuthenticated();
      
      // Solo el creador puede actualizar/eliminar sus propias inspecciones
      allow update, delete: if isAuthenticated() && 
                               (resource.data.conductorId == request.auth.uid || 
                                request.resource.data.conductorId == request.auth.uid);
    }
    
    // Reglas para colección de alertas
    match /alertas/{alertaId} {
      // Cualquier usuario autenticado puede leer alertas
      allow read: if isAuthenticated();
      
      // Cualquier usuario autenticado puede escribir alertas
      allow write: if isAuthenticated();
    }
    
    // Reglas para colección de conductores
    match /conductores/{conductorId} {
      // Cualquier usuario autenticado puede leer conductores
      allow read: if isAuthenticated();
      
      // Cualquier usuario autenticado puede escribir
      allow write: if isAuthenticated();
    }
  }
}
